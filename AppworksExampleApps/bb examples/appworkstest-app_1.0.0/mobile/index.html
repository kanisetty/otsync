<!DOCTYPE html>
<html lang="en">
  <head>
    <title>appworks js object</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	
  </head>
  <body>
	
	<button type="button" onclick="refreshHTML()">Refresh HTML</button>	
	<button type="button" onclick="doDownload()">Do Download</button>	
	<br/>
	<br/>	
	<button type="button" onclick="closeMe()">Close Me</button>	
	<button type="button" onclick="isOnline()">Is Online?</button>
	<br/>
	<br/>
	<button type="button" onclick="getDefaultLanguage()">Get Default Language</button>	
	<br/>
	<br/>	
	<button type="button" onclick="getSessionInfo()">Get Session Info</button>
	<button type="button" onclick="getOS()">Get OS</button>	
	<br/>
	<br/>	
	<button type="button" onclick="authenticate()">Authenticate</button>	
	<br/>
	<br/>	
	<button type="button" onclick="openCamera()">Open Camera</button>
	<br/>
	<br/>
	<button type="button" onclick="getFromGallery()">Get From Gallery</button>
	<br/>
	<br/>
	<button type="button" onclick="openFilePicker()">Open File Picker</button>
	<br/>
	<br/>
	<button type="button" onclick="makeAjaxCall()">AJAX request to FaceBook Graph REST API</button>
	<button type="button" onclick="addFaves()">Add JSON data to store</button>
	<button type="button" onclick="getFave1()">Get JSON data 1 by id</button>
	<button type="button" onclick="getArrayFave()">Get JSON data that holds array</button>
	<button type="button" onclick="getAllFaves()">Get data per type</button>
	<br/>
	<br/>

	<div id="picture_wrapper">
		<img id="picture" />
	</div>	
	
    <script src="js/vendor/jquery-2.1.3.min.js"></script>
	
	<script type="text/javascript" src="appworks.js"></script>	
	<script src="js/appworks-storage.js"></script>
	<script src="js/appworks-cache-client.js"></script>

	<script type="text/javascript">
					
	function refreshHTML()
	{
		location.reload(true);
	}

	function doDownload() 
	{
		// form a content server download request and open the resulting download

		// this is a very specific exmaple with required backing services, at the time of writing we are using 
		// gateway:  http://jt-cmhc-appw.opentext.net:8080
		// cs:       http://jt-cmhc-cs1.opentext.net/otcsu13/llisapi.dll 
		// creds:    otadmin@otds.admin/0P3nt3xt

		var llCookie = getLlCookie();
		if (typeof llCookie == "undefined" || llCookie == "")
		{
			alert("Failed to resolve the LLCookie! Download will not proceed.");
			return;
		}

		var relativePath = "/content/ContentChannel";
		//var fileName = "icon.png";
		//var nodeID = "123631";
		var fileName = "Changepoint timekeeping system.docx";
		var nodeID = "123411";

		var headers = { 
			"Cookie" : "LLCookie=" + llCookie
		};
		var queryParams = {
			"nodeID" : nodeID
		};

		var openOnReturn = true;

		// ask the runtime to cache the document using these settings 
		var cacheRequest = AppWorksCache.getBaseCacheRequest(fileName, "com.opentext.bb.example", "1");

		// allow the user to select the location to which the file is downloaded, then chain the download
		// request
		AppWorks.selectFilePath(function (data) {
			alert('selectFilePath returned ' + JSON.stringify(data));

			if (data.success) {
				var destPath = data.filePath;
				alert('user selected dest path: ' + destPath); 

				var dlRequest = AppWorks.createDownloadRequest(fileName, relativePath, 
					headers, queryParams, openOnReturn, cacheRequest, destPath);

				alert("Issuing download request " + JSON.stringify(dlRequest));
				AppWorks.downloadFile(dlRequest, 
					function(data) {
						alert('download succeeded ' + JSON.stringify(data));

						alert('The upload and download function both return the reponse headers - ' + 
							JSON.stringify(data.headers));
						// ensure the item was cached
						AppWorksCache.isItemInCache(cacheRequest, function(data) {
							alert('item was cached result - ' + JSON.stringify(data));	
						});
					},
					function(data) {
						alert('download failed ' + JSON.stringify(data));
				});
			} else {
				alert('looks like the user cancelled the selection, do not perform download');
			}
		});
	}

	function getLlCookie() 
	{
		try {
			var cookieObj = (document.cookie || '').split(/;\s*/).reduce(function(re, c) {
				  var tmp = c.match(/([^=]+)=(.*)/);
				  if (tmp) re[tmp[1]] = unescape(tmp[2]);
				  return re;
				}, {});	
			return encodeURIComponent(cookieObj['LLCookie']);
		} catch (e) {
			return "";
		}
	}

	function authenticate()
	{
		var successFn = function () {
			alert('authenticated ,otag.auth = ' + JSON.stringify(window.otag.auth));
		};
		var errorFn = function () {};

		var namespace = "LoginPlugin";
		var func = "authenticate";
		
		var params = [];
		
		alert('called authenticate, otag.auth =' + JSON.stringify(window.otag.auth));

		cordova.exec(successFn, errorFn, namespace, func, params);		
	}

	function closeMe()
	{
		var successFn = function () {};
		var errorFn = function () {};

		var namespace = "ApplicationPlugin";
		var func = "closeMe";
		
		var params = [];
		
		cordova.exec(successFn, errorFn, namespace, func, params);	
	}

	function getDefaultLanguage()
	{
		var lang;
		
		var successFn = function () {
			var args = Array.prototype.slice.call(arguments);
			lang = args[0];
		};
		var errorFn = function () {		
			var args = Array.prototype.slice.call(arguments);
			alert(args);
		}; 

		var namespace = "DeviceInfoPlugin";
		var func = "getDefaultLanguage";

		var params = [];
		
		cordova.exec(successFn, errorFn, namespace, func, params || []);
		
		alert(lang);
	}

	function isOnline() 
	{
		AppWorks.isOnline(function(data) {
			alert('isOnline returned - ' + JSON.stringify(data));
		})
	}

	function getSessionInfo()
	{
		var json;
		
		var successFn = function () {
			var args = Array.prototype.slice.call(arguments);
			json = args[0];
		};
		var errorFn = function () {
			var args = Array.prototype.slice.call(arguments);
			alert(args);
		};

		var namespace = "SessionPlugin";
		var func = "getSessionInfo";
		
		var params = [];
		
		cordova.exec(successFn, errorFn, namespace, func, params);	

		alert(json.baseURL);
		alert(json.username);
		alert(json.clientOS);
		alert(json.clientVersion);
		alert(json.clientID);	
		
	}

	function getOS()
	{
		var json
		
		cordova.exec(
				function(){
					var args = Array.prototype.slice.call(arguments);
					json = args[0];
				}
				, function(){var args = Array.prototype.slice.call(arguments);}
				, "SessionPlugin"
				, "getSessionInfo"
				, []
			);
		alert(json.clientOS);
	}


	function openCamera()
	{
		
		var successFn = function (data) {
			// if we succeed the base64 string is too big to alert
			console.log("cordova.exec success openCamera - " + JSON.stringify(data));
			if (typeof data.file != 'undefined' && data.file.length > 0) {
				$("#picture").attr("src","data:image/png;base64,"+data.file);
			} else {
				alert("Looks like the user closed the camera - " + JSON.stringify(data));
			}
		};

		var errorFn = function (data) {
			alert("cordova.exec error openCamera - " + JSON.stringify(data));
		};
		
		var namespace = "AppWorks";
		var func = "openCamera";		

		cordova.exec(successFn, errorFn, namespace, func, []);			

	}
	
	
	function getFromGallery()
	{
	
		var successFn = function (data) {
			// if we succeed the base64 string is too big to alert
			console.log("cordova.exec success getFromGallery - " + JSON.stringify(data));
			if (typeof data.file != 'undefined' && data.file.length > 0) {
				$("#picture").attr("src","data:image/png;base64,"+ data.file);
			} else {
				alert("Looks like the user closed the gallery - " + JSON.stringify(data));
			}
		};
		
		var errorFn = function (data) {
			alert("cordova.exec error getFromGallery - " + JSON.stringify(data));
		};	
		
		var namespace = "AppWorks";
		var func = "getFromGallery";

		cordova.exec(successFn, errorFn, namespace, func, []);		
	}
	
	function openFilePicker()
	{
		var successFn = function (data) {
			// if we succeed the base64 string is too big to alert
			console.log("cordova.exec success openFilePicker - " + JSON.stringify(data));
			if (typeof data.file != 'undefined' && data.file.length > 0) {
				alert("Successfully retrieved data for file " + data.fileName);
			} else {
				alert("Looks like the user closed the file picker - " + JSON.stringify(data));
			}
		};
		
		var errorFn = function (data) {
			alert("cordova.exec error openFilePicker - " + JSON.stringify(data));
		};	
		
		var namespace = "AppWorks";
		var func = "openFilePicker";
		
		cordova.exec(successFn, errorFn, namespace, func, []);	
	}	

	function makeAjaxCall() 
	{
		var successFn = function(){};
		var errorFn = function(){};	

		var namespace = "Session";
		var func = "http";

		var json = {
			success: function(data) {
				if (data) {
					var successObj = JSON.stringify(data, null, 4);
					alert("makeAjaxCall.success - " + successObj);
				}
			}, 
			error: function(data) {
				if (data) {
					var errObj = JSON.stringify(data, null, 4);
					alert("makeAjaxCall.error - " + errObj);
				}
			},
			url : "http://graph.facebook.com/bgolub",
			type : "GET",
			queryParams : {
				fields : "id,name,picture"
			}
		};		 

		var params = [json];		

		alert('requesting data from http://graph.facebook.com/bgolub?fields=id%2Cname%2Cpicture');

		cordova.exec(successFn, errorFn, namespace, func, params || []);		
	}

	// include the appworks-storage.js file
	var storage = AppWorksStorage;
	var app = "appworkstest-app";
	var dataType = "com.opentext.Favorites";

	var arrayFaveId = "arrayItem1";

	function buildFave(docId, fileName, comment) {
		return {
			docId : docId,
			fileName : fileName,
			comment : comment
		};
	}

	function addFaves() 
	{
		var faveId1 = "1";

		var fave1 = buildFave("id1", "myPdf.pdf", "I like pdfs");

		// this will create the data type structure for us
		var newFaveReq1 = storage.getStorageRequest(dataType, app, faveId1, fave1);

		storage.put(newFaveReq1, function(data) {
			alert('newFaveReq1 -> ' + JSON.stringify(data, null, 2));
		});

		var newFaveReq2 = storage.getStorageRequest(dataType, app, "2", 
			buildFave("id2", "catPic.jpg", "I like JPEGs"));

		storage.put(newFaveReq2, function(data) {
			alert('newFaveReq2 -> ' + JSON.stringify(data, null, 2));
		});

		// test adding an array of data
		var arrayDataRequest = storage.getStorageRequest(dataType, app, arrayFaveId, 
			[{ name : "Mr.0", value: "I'm first" }, 
			 { name : "Mr.1", value: "I'm number one"}, 
			 { name : "Mr.2", value: "Seconds the best"}]);

		storage.put(arrayDataRequest, function(data) {
			alert('arrayDataRequest ->' + JSON.stringify(data, null, 2));
		});
	}

	function getFave1() 
	{
		storage.getItemFromStore(app, dataType, "1", function(data) {
			alert('getItemFromStore id=1-> ' + JSON.stringify(data, null, 2));	
		});
	}

	function getArrayFave() 
	{
		storage.getItemFromStore(app, dataType, arrayFaveId, function(data) {
			alert('getItemFromStore id=' + arrayFaveId + ' -> ' + JSON.stringify(data, null, 2));	
		});
	}

	function getAllFaves() 
	{
		storage.getByTypeFromStore(app, dataType, function(data) {
			alert('getByTypeFromStore type=' + dataType + ' -> ' + JSON.stringify(data));	
		});
	}

	function getAllFaves() 
	{
		storage.getByTypeFromStore(app, dataType, function(data) {
			alert('getByTypeFromStore type=' + dataType + ' -> ' + JSON.stringify(data));	
		});
	}


	document.addEventListener("deviceready", ourDeviceReadyHandler, false);
	function ourDeviceReadyHandler() 
	{
		alert('cordova deviceready was called, you can now use the device APIs');
	}

	</script>
	
  </body>
</html>
