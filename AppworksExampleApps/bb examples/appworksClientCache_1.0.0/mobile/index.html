<html>
	<head>
		<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
		<script type="text/javascript" src="appworks.js"></script>	
		<script src="js/appworks-cache-client.js"></script>

		<script type="text/javascript">
			$(document).ready(function () {
				var appNamespace = "com.opentext.cache.test";

				// we store the same file using three unique name to fill the cache (I harcoded the limit to 10KB) 
				var testFile = 'test.pdf'; 
				var testFile2 = "test2.pdf";
				var testFile3 = "test3.pdf";

				// version testing
				var version = 1;

				// a base request we can use to make some of our calls
				var baseRequest = AppWorksCache.getBaseCacheRequest(testFile, appNamespace, version);

				populateCacheInfo();

				AppWorksCache.isItemInCache(baseRequest, function(data) {
					$('#fileExists').text(data.itemIsInCache);
				});
				
				$('#evict').click(function() {
					alert('Evicting ' + baseRequest.testFile + ' from cache');
					AppWorksCache.evictItemFromCache(baseRequest, function(data) {
						if (data.itemWasEvicted) {
							alert(testFile + ' was evicted from the cache');
						} else {
							alert(testFile + ' was not evicted from the cache');
						}
					});
				});

				$('#refreshStatus').click(function() {
					populateCacheInfo();
					AppWorksCache.isItemInCache(baseRequest, function(data) {
						$('#fileExists').text(data.itemIsInCache);
					});
				});

				$('#getInfo').click(function() {
					AppWorksCache.getCacheItemInfo(baseRequest, function(data) {
						alert('{fileName":"' + data.cacheItem.fileName + 
							'","modifiedDate":"' + data.cacheItem.modifiedDate + 
							'","expires":"' + data.cacheItem.expires + 
							'","version":"' + data.cacheItem.version + '"}');
					});
				});

				var openOnReturn = true;	
				$('#getFile1').click(function() {
					AppWorksCache.getCacheItem(baseRequest, openOnReturn, function(data) {
						alert('Got data String for file 1 ' + data.cacheItem.fileDataString);
					});
				});

				$('#addItem').click(function() {
					var addItemRequest1 = AppWorksCache.getBaseCacheRequest(testFile, appNamespace, version);
					addItemRequest1.expires = getExpiry(1);
					addItemCall(addItemRequest1);
				});

				$('#addFile2').click(function() {
					var addItemRequest2 = AppWorksCache.getBaseCacheRequest(testFile2, appNamespace, version);
					addItemRequest2.expires = getExpiry(5); // expires in 5 days
					addItemCall(addItemRequest2);
				});

				$('#addFile3').click(function() {
					var addItemRequest3 = AppWorksCache.getBaseCacheRequest(testFile3, appNamespace, version);
					addItemRequest3.expires = getExpiry(10); // expires in 10 days
					addItemCall(addItemRequest3);
				});

				function populateCacheInfo() {
					AppWorksCache.getCacheInfo(function(data) {
						if (data.cacheInfo) {
							$('#maxSize').text(data.cacheInfo.maxSize);
							$('#used').text(data.cacheInfo.currentSize);
							$('#free').text(data.cacheInfo.freeSpace);
						}
					});
				}

				// downloads a test pdf from the web and store it in the cache
				function addItemCall(cacheRequest) {
					var pdfRequest = new XMLHttpRequest();  
					pdfRequest.responseType = "arraybuffer";

					pdfRequest.onreadystatechange = function() {
						if (pdfRequest.readyState == 4 /* DONE */ && pdfRequest.status == 200) {
								pdfRequest.onreadystatechange = null;
						        addItem(cacheRequest, pdfRequest.response);
						        return false;
						} 
					};
 
					pdfRequest.open("GET", "http://ir.hubspot.com/files/doc_downloads/test.pdf", true);
					pdfRequest.send();
				}

				function addItem(cacheRequest, arraybuffer) {

			        AppWorksCache.addItemToCache(cacheRequest, arraybuffer, function(data) {
			        	// make expires readable
			        	var expires = new Date(parseInt(data.expires, 10));
			        	alert('add request returned, itemWasCached= ' + data.itemWasCached + ', expires= ' + expires); 
			        });	
				}

				function getExpiry(days) {
					return new Date().getTime() + (days * 24 * 60*60*1000);
				}
			});
		</script>
	</head>
	<body>	
		<h1>MAX CACHE SIZE: </h1>
		<div id="maxSize"></div>
		<h1>SPACE USED: </h1>
		<div id="used"></div>
		<h1>FREE SPACE: </h1>
		<div id="free"></div>
		</br>
		</br>
		<h1>test.pdf EXISTS = </h1>
		<div id="fileExists"></div>

		<!-- Evict button, and refresh fileExists-->
		<input type="button" id="evict">Evict</input>
		</br>
		<input type="button" id="refreshStatus">Refresh</input> 
		</br>
		<input type="button" id="addItem">Add</input>
		</br>
		<input type="button" id="getInfo">Get File 1 Info</input>
		</br>
		<input type="button" id="getFile1">Get File 1 Data</input>
		</br>
		<input type="button" id="addFile2">Add second copy</input>
		</br>
		<input type="button" id="addFile3">Add third copy</input>
	</body>		
</html>